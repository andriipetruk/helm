apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "fullname" . }}-grafana-dashboard-job
  labels:
    app: {{ template "fullname" . }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-5"
spec:
  activeDeadlineSeconds: 3600
  template:
    metadata:
      labels:
        app: {{ template "fullname" . }}
        release: "{{ .Release.Name }}"
    spec:
      containers:
      - name: {{ template "fullname" . }}-grafana-dashboard-curl
        image: "appropriate/curl:latest"
        env:
        - name: DASHBOARD_JSON
          valueFrom:
            configMapKeyRef:
              name: {{ template "fullname" . }}-grafana-conf
              key: dashboard.json
        args:
          - "http://{{ .Values.grafana.server.adminUser }}:{{ .Values.grafana.server.adminPassword }}@{{ template "grafana.fullname" . }}:{{ .Values.grafana.server.service.httpPort }}/api/dashboards/db"
          - "--max-time"
          - "10"
          - "-H"
          - "Content-Type: application/json;charset=UTF-8"
          - "--data-binary"
          - "{ \"dashboard\":$(DASHBOARD_JSON), \"overwrite\":true }"
      restartPolicy: "OnFailure"